<div class="container mt-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><%= link_to t('terakoya.classes.all_classes'), terakoya_classes_path %></li>
          <li class="breadcrumb-item active" aria-current="page"><%= @class.name %></li>
        </ol>
      </nav>

      <div class="d-flex justify-content-between align-items-start">
        <div>
          <h1><%= @class.name %></h1>
          <p class="lead text-muted"><%= @class.description %></p>
        </div>
        <div>
          <span class="badge" style="background-color: <%= @class.color %>; font-size: 1rem;">
            <%= t("terakoya.classes.visibility.#{@class.visibility}") %>
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Class Info & Actions -->
  <div class="row mb-4">
    <div class="col-md-8">
      <div class="card">
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <h6 class="text-muted mb-2"><%= t('terakoya.classes.leader') %></h6>
              <p class="mb-0"><%= @class.leader.display_name %></p>
              <% if @class.leader.bio.present? %>
                <small class="text-muted"><%= truncate(@class.leader.bio, length: 100) %></small>
              <% end %>
            </div>

            <div class="col-md-6 mb-3">
              <h6 class="text-muted mb-2"><%= t('terakoya.classes.schedule') %></h6>
              <p class="mb-0">
                <%= @class.meeting_schedule.presence || t('terakoya.classes.no_fixed_schedule') %>
              </p>
            </div>

            <div class="col-md-6 mb-3">
              <h6 class="text-muted mb-2"><%= t('terakoya.classes.members') %></h6>
              <p class="mb-0">
                <%= @class.current_members %>
                <% if @class.capacity %>
                  / <%= @class.capacity %> <%= t('terakoya.classes.spots') %>
                <% else %>
                  <%= t('terakoya.classes.unlimited_spots') %>
                <% end %>
              </p>
            </div>

            <div class="col-md-6 mb-3">
              <h6 class="text-muted mb-2"><%= t('terakoya.classes.status') %></h6>
              <p class="mb-0">
                <span class="badge bg-<%= class_status_color(@class.status) %>">
                  <%= t("terakoya.classes.status.#{@class.status}") %>
                </span>
              </p>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="mt-3">
            <% if leader_mode? && @class.leader == current_leader %>
              <%= link_to t('terakoya.classes.edit'), edit_terakoya_class_path(@class), class: "btn btn-primary" %>
              <%= button_to t('terakoya.classes.archive'), terakoya_class_path(@class),
                  method: :delete, data: { confirm: t('terakoya.classes.archive_confirm') },
                  class: "btn btn-outline-danger" %>
            <% elsif partner_mode? && current_partner %>
              <% if @class.partners.include?(current_partner) %>
                <%= button_to t('terakoya.classes.leave'), leave_terakoya_class_path(@class),
                    method: :post, data: { confirm: t('terakoya.classes.leave_confirm') },
                    class: "btn btn-outline-danger" %>
              <% elsif @class.can_accept_members? %>
                <%= button_to t('terakoya.classes.join'), join_terakoya_class_path(@class),
                    method: :post, class: "btn btn-success btn-lg" %>
              <% elsif @class.at_capacity? %>
                <button class="btn btn-secondary" disabled><%= t('terakoya.classes.full') %></button>
              <% end %>
            <% end %>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar -->
    <div class="col-md-4">
      <!-- Upcoming Events -->
      <div class="card mb-3">
        <div class="card-header">
          <h6 class="mb-0"><%= t('terakoya.classes.upcoming_events') %></h6>
        </div>
        <div class="card-body">
          <% if @upcoming_events.any? %>
            <ul class="list-unstyled mb-0">
              <% @upcoming_events.each do |event| %>
                <li class="mb-2">
                  <small>
                    <strong><%= event.title %></strong><br>
                    <%= l(event.start_time, format: :short) %>
                  </small>
                </li>
              <% end %>
            </ul>
            <%= link_to t('terakoya.calendar.view_all'), calendar_path, class: "btn btn-sm btn-outline-primary mt-2" %>
          <% else %>
            <p class="text-muted mb-0"><%= t('terakoya.classes.no_upcoming_events') %></p>
          <% end %>
        </div>
      </div>

      <!-- Quick Links -->
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0"><%= t('terakoya.classes.quick_links') %></h6>
        </div>
        <div class="list-group list-group-flush">
          <%= link_to calendar_path, class: "list-group-item list-group-item-action" do %>
            üìÖ <%= t('terakoya.classes.view_calendar') %>
          <% end %>
          <% if @class.partners.include?(current_partner) || @class.leader == current_leader %>
            <%= link_to notes_path(terakoya_class_id: @class.id), class: "list-group-item list-group-item-action" do %>
              üìù <%= t('terakoya.classes.class_notes') %>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Members List -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0"><%= t('terakoya.classes.members_list') %> (<%= @members.count %>)</h5>
        </div>
        <div class="card-body">
          <% if @members.any? %>
            <div class="row">
              <% @members.each do |partner| %>
                <div class="col-md-4 mb-3">
                  <div class="d-flex align-items-center">
                    <div class="avatar-placeholder me-3" style="width: 48px; height: 48px; background: <%= @class.color %>20; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                      <strong style="color: <%= @class.color %>;">
                        <%= partner.display_name[0].upcase %>
                      </strong>
                    </div>
                    <div>
                      <strong><%= partner.display_name %></strong><br>
                      <small class="text-muted">
                        <%= t('terakoya.classes.joined_on') %>:
                        <%= l(partner.class_memberships.find_by(terakoya_class: @class).joined_at, format: :short) %>
                      </small>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <p class="text-muted mb-0"><%= t('terakoya.classes.no_members_yet') %></p>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Notes -->
  <% if @recent_notes.any? %>
    <div class="row mt-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><%= t('terakoya.classes.recent_notes') %></h5>
            <%= link_to t('terakoya.notes.view_all'), notes_path(terakoya_class_id: @class.id), class: "btn btn-sm btn-outline-primary" %>
          </div>
          <div class="card-body">
            <% @recent_notes.each do |note| %>
              <div class="mb-3 pb-3 border-bottom">
                <h6><%= note.title.presence || t('terakoya.notes.untitled') %></h6>
                <p class="text-muted mb-1"><%= truncate(note.content.to_plain_text, length: 200) %></p>
                <small class="text-muted">
                  <%= t('terakoya.notes.by') %> <%= note.author.display_name %> ‚Ä¢
                  <%= time_ago_in_words(note.created_at) %> <%= t('terakoya.notes.ago') %>
                </small>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% end %>
</div>

<style>
  .avatar-placeholder {
    font-size: 1.25rem;
  }
</style>
